<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è²æ§åœ‹åœŸé³¥ - å®‰å…¨é£›è¡ŒæŒ‘æˆ°</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background-color: #333;
            font-family: 'Press Start 2P', cursive;
            touch-action: none;
            user-select: none;
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 100%;
            background-color: #70c5ce; /* åˆå§‹å¤©ç©ºè— */
            image-rendering: pixelated;
            transition: background-color 2s ease;
        }

        /* ææ€–èƒŒæ™¯æ¨£å¼ */
        .scary-mode {
            background-color: #4a0000 !important;
            animation: shake 0.5s infinite;
        }
        @keyframes shake {
            0% { transform: translate(1px, 1px); }
            50% { transform: translate(-1px, -1px); }
            100% { transform: translate(1px, 1px); }
        }

        /* UI å±¤è¨­å®š */
        .ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .hud {
            display: flex;
            justify-content: space-between;
            padding: 20px;
            font-size: 20px;
            color: white;
            text-shadow: 2px 2px 0 #000;
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: white;
            z-index: 100;
            pointer-events: auto;
            padding: 20px; /* å¢åŠ å…§è·é˜²æ­¢è²¼é‚Š */
            box-sizing: border-box;
        }

        .hidden {
            display: none !important;
        }

        /* ã€ä¿®æ”¹ 4ã€‘ä¿®å¾©æ¨™é¡Œæ’ç‰ˆ */
        h1 {
            line-height: 1.4;
            color: #FFD700;
            text-shadow: 4px 4px 0 #000;
            font-size: 24px; /* ç¨å¾®èª¿å°ä¸€é»ç¢ºä¿ä¸çˆ†ç‰ˆ */
            margin: 0 0 25px 0; /* ç§»é™¤å·¦å³é‚Šè·ï¼Œå¢åŠ ä¸‹æ–¹é‚Šè· */
            max-width: 100%;
        }

        button {
            font-family: 'Press Start 2P', cursive;
            padding: 20px 30px;
            font-size: 18px;
            background: #ff5500;
            color: white;
            border: 4px solid #fff;
            cursor: pointer;
            box-shadow: 6px 6px 0px #000;
            margin-top: 30px;
            transition: transform 0.1s;
        }

        button:active {
            transform: translate(3px, 3px);
            box-shadow: 3px 3px 0px #000;
        }

        /* ã€ä¿®æ”¹ 3ã€‘ç§»é™¤æ’è¡Œæ¦œç›¸é—œ CSS */

        .assets { display: none; }
    </style>
</head>
<body>

    <div class="assets">
        <img id="img-bird" src="fly_right.png" alt="Bird">
        <img id="img-hit" src="fly_hit.png" alt="Hit">
    </div>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        
        <div class="ui-layer">
            <div class="hud">
                <span id="scoreDisplay">SCORE: 0</span>
                <span id="timeDisplay">â±ï¸ 0.0s</span>
            </div>
            <div style="position:absolute; left:20px; top:80px; width:15px; height:100px; border:2px solid white;">
                <div id="micBar" style="background:#0f0; width:100%; height:0%; position:absolute; bottom:0;"></div>
            </div>
        </div>
        
        <div id="startScreen" class="overlay">
            <h1>æ­¡è¿ä¾†åˆ°<br>ã€Šè²æ§åœ‹åœŸé³¥ã€‹<br>å®‰å…¨é£›è¡ŒæŒ‘æˆ°</h1>
            
            <p style="margin:20px 0; line-height:1.8; color: #fff;">
                å‡ºè² = å¾€ä¸Šé£›<br>
                å®‰éœ = å¾€ä¸‹å¢œ
            </p>
            
            <div style="margin: 10px 0; font-size: 14px; text-align: left; display: inline-block; max-width: 80%; line-height: 1.6;">
                <div style="color: #88ccff;">
                    è«‹æº–å‚™å¥½ä½ çš„å–‰åš¨ï¼Œ<br>
                    ç”¨è²éŸ³æ§åˆ¶åœ‹åœŸé³¥èº²é¿éšœç¤™ã€‚<br><br>
                    è®“æˆ‘å€‘å¯æ„›çš„åœ‹åœŸé³¥ï¼Œ<br>
                    å¯ä»¥å¹³å®‰çš„å›å®¶ï¼
                </div>                  
            </div>

            <button id="startBtn">å…è¨±éº¥å…‹é¢¨ä¸¦é–‹å§‹</button>
        </div>

        <div id="gameOverScreen" class="overlay hidden">
            <h1>ğŸ‘· å·¥å®‰æ„å¤–!</h1>
            <p>æœ¬æ¬¡å­˜æ´»</p>
            <h2 id="finalTime" style="font-size: 40px; color: #fff; margin: 10px 0;">0s</h2>
            <p>æœ¬æ¬¡å¾—åˆ†</p>
            <h2 id="finalScore" style="font-size: 50px; color: #FFD700; margin: 10px 0;">0</h2>
            
            <button onclick="location.reload()">å†è©¦ä¸€æ¬¡</button>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒè®Šæ•¸ ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const birdImg = document.getElementById('img-bird');
        const hitImg = document.getElementById('img-hit');
        
        let audioContext, analyser, microphone, dataArray;
        let currentVolume = 0;
        let isMicReady = false;

        let gameState = 'START';
        let frames = 0;
        let score = 0;
        let startTime = 0;
        let survivalTime = 0;

        // --- éŸ¿æ‡‰å¼ç•«å¸ƒ ---
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // --- é³¥ (ç‰©ç†é‚è¼¯) ---
        const bird = {
            x: 50,
            y: 200,
            width: 50,
            height: 50,
            velocity: 0,
            gravity: 0.25,
            rotation: 0,
            
            draw: function() {
                ctx.save();
                ctx.translate(this.x + this.width/2, this.y + this.height/2);
                
                if (gameState === 'PLAYING') {
                    this.rotation = Math.min(Math.PI / 4, Math.max(-Math.PI / 4, (this.velocity * 0.1)));
                } else if (gameState === 'GAMEOVER') {
                    this.rotation += 0.3;
                }
                ctx.rotate(this.rotation);

                let renderImg = (gameState === 'GAMEOVER') ? hitImg : birdImg;
                if (renderImg.complete && renderImg.naturalHeight !== 0) {
                    ctx.drawImage(renderImg, -this.width/2, -this.height/2, this.width, this.height);
                } else {
                    ctx.fillStyle = (gameState === 'GAMEOVER') ? 'red' : 'yellow';
                    ctx.fillRect(-this.width/2, -this.height/2, this.width, this.height);
                }
                ctx.restore();
            },

            update: function() {
                this.velocity += this.gravity;
                this.y += this.velocity;

                if (this.y + this.height >= canvas.height) {
                    this.y = canvas.height - this.height;
                    gameOver();
                }
                if (this.y < 0) {
                    this.y = 0;
                    this.velocity = 0;
                }

                // --- è²æ§é–¾å€¼ä¿®æ­£å€ ---
                // ã€ä¿®æ”¹ 2ã€‘èª¿ä½é–€æª»ï¼Œæé«˜éˆæ•åº¦ (åŸç‚º 55)
                let threshold = 40; 

                if (currentVolume > threshold) {
                    let intensity = (currentVolume - threshold) / (255 - threshold);
                    let boost = intensity * 4.0; 
                    this.velocity = -4.0 - boost;
                }
            }
        };

        // --- éšœç¤™ç‰© ---
        const obstacles = {
            list: [],
            gap: 200, 
            dx: 3, 

            draw: function() {
                for (let i = 0; i < this.list.length; i++) {
                    let p = this.list[i];
                    
                    ctx.fillStyle = (survivalTime > 60) ? '#000' : '#555'; 

                    // ã€ä¿®æ”¹ 1ã€‘ ç¹ªè£½é‚è¼¯ï¼šæ ¹æ“š easyType æ±ºå®šç¹ªè£½å“ªä¸€é‚Š
                    // ç¹ªè£½ä¸Šç®¡ (å¦‚æœæ˜¯æ­£å¸¸æ¨¡å¼ æˆ–æ˜¯ åƒ…ä¸Šæ–¹æ¨¡å¼)
                    if (p.easyType !== 'bottomOnly') {
                        ctx.fillRect(p.x, 0, p.w, p.top);
                        // è£é£¾
                        ctx.fillStyle = '#333';
                        ctx.fillRect(p.x + 10, 0, 5, p.top);
                        ctx.fillRect(p.x + p.w - 15, 0, 5, p.top);
                        ctx.fillStyle = (survivalTime > 60) ? '#000' : '#555'; // é‡ç½®é¡è‰²çµ¦ä¸‹ç®¡ç”¨
                    }

                    // ç¹ªè£½ä¸‹ç®¡ (å¦‚æœæ˜¯æ­£å¸¸æ¨¡å¼ æˆ–æ˜¯ åƒ…ä¸‹æ–¹æ¨¡å¼)
                    if (p.easyType !== 'topOnly') {
                        ctx.fillRect(p.x, canvas.height - p.bottom, p.w, p.bottom);
                        // è£é£¾
                        ctx.fillStyle = '#333';
                        ctx.fillRect(p.x + 10, canvas.height - p.bottom, 5, p.bottom);
                        ctx.fillRect(p.x + p.w - 15, canvas.height - p.bottom, 5, p.bottom);
                    }
                }
            },

            update: function() {
                let frameInterval;
                let posRange; 
                let isEasyMode = false; // æ¨™è¨˜æ˜¯å¦ç‚ºç°¡æ˜“æ¨¡å¼

                // ã€ä¿®æ”¹ 1ã€‘ é›£åº¦æ›²ç·šèª¿æ•´ï¼š0-8ç§’åŠ å…¥ç°¡æ˜“æ¨¡å¼
                if (survivalTime < 8) {
                    // 0-8s: ç°¡æ˜“æ¨¡å¼ (å–®é‚Šç®¡)
                    this.dx = 3;
                    this.gap = 400; // é›–ç„¶å–®é‚Šç”¨ä¸åˆ° gapï¼Œä½†è¨­å¤§ä¸€é»é¿å…é‚è¼¯éŒ¯èª¤
                    frameInterval = 200; // ç”Ÿæˆæ…¢ä¸€é»
                    posRange = canvas.height * 0.1;
                    isEasyMode = true;
                } else if (survivalTime < 15) {
                    // 8-15s: æ­£å¸¸ç°¡å–®
                    this.dx = 3;          
                    this.gap = 260;        
                    frameInterval = 180;  
                    posRange = canvas.height * 0.1; 
                } else if (survivalTime < 30) {
                    // 15-30s: æ™®é€š
                    this.dx = 4;
                    this.gap = 220;
                    frameInterval = 140;
                    posRange = canvas.height * 0.2;
                } else if (survivalTime < 60) {
                    // 30-60s: åŠ é€Ÿ
                    this.dx = 5;
                    this.gap = 170;
                    frameInterval = 100;
                    posRange = canvas.height * 0.35;
                    canvas.style.backgroundColor = "#e6a65c";
                } else {
                    // 60s+: åœ°ç„
                    this.dx = 7;
                    this.gap = 150;
                    frameInterval = 80;
                    posRange = canvas.height * 0.4;
                    canvas.classList.add('scary-mode');
                }

                if (frames % frameInterval === 0) {
                    let center = canvas.height / 2;
                    let topHeight = center - (this.gap / 2) + (Math.random() - 0.5) * posRange;

                    let minPipe = 50;
                    if (topHeight < minPipe) topHeight = minPipe;
                    if (topHeight > canvas.height - this.gap - minPipe) topHeight = canvas.height - this.gap - minPipe;

                    let obstacleData = {
                        x: canvas.width,
                        w: 70,
                        top: topHeight,
                        bottom: canvas.height - (topHeight + this.gap),
                        easyType: null // é è¨­ç‚ºæ­£å¸¸é›™é‚Šç®¡
                    };

                    // ã€ä¿®æ”¹ 1ã€‘ å¦‚æœæ˜¯ç°¡æ˜“æ¨¡å¼ï¼Œéš¨æ©Ÿæ±ºå®šåªç•™ä¸Šæ–¹æˆ–ä¸‹æ–¹
                    if (isEasyMode) {
                        obstacleData.easyType = Math.random() < 0.5 ? 'topOnly' : 'bottomOnly';
                    }

                    this.list.push(obstacleData);
                }

                for (let i = 0; i < this.list.length; i++) {
                    let p = this.list[i];
                    p.x -= this.dx;

                    // ã€ä¿®æ”¹ 1ã€‘ ç¢°æ’åµæ¸¬ï¼šæ ¹æ“š easyType åˆ¤æ–·
                    // æ’åˆ°ä¸Šç®¡ (å‰ææ˜¯ä¸Šç®¡å­˜åœ¨)
                    if (p.easyType !== 'bottomOnly' && bird.x + bird.width > p.x && bird.x < p.x + p.w && bird.y < p.top) gameOver();
                    // æ’åˆ°ä¸‹ç®¡ (å‰ææ˜¯ä¸‹ç®¡å­˜åœ¨)
                    if (p.easyType !== 'topOnly' && bird.x + bird.width > p.x && bird.x < p.x + p.w && bird.y + bird.height > canvas.height - p.bottom) gameOver();

                    if (p.x + p.w < 0) {
                        this.list.shift();
                        score++;
                        document.getElementById('scoreDisplay').innerText = "SCORE: " + score;
                    }
                }
            },
            reset: function() { this.list = []; }
        };

        // --- ç³»çµ±åŠŸèƒ½ ---
        async function initAudio() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);
                analyser.fftSize = 256;
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                isMicReady = true;
                startGame();
            } catch (err) {
                alert("ç„¡æ³•å•Ÿç”¨éº¥å…‹é¢¨ï¼è«‹ç¢ºèªæ¬Šé™ã€‚");
            }
        }

        function getVolume() {
            if (!analyser) return 0;
            analyser.getByteFrequencyData(dataArray);
            let sum = 0;
            for(let i = 0; i < dataArray.length; i++) sum += dataArray[i];
            return sum / dataArray.length; 
        }

        // ã€ä¿®æ”¹ 3ã€‘ç§»é™¤ updateLeaderboard å‡½æ•¸

        function startGame() {
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('gameOverScreen').classList.add('hidden');
            gameState = 'PLAYING';
            score = 0;
            frames = 0;
            survivalTime = 0;
            startTime = Date.now();
            bird.y = canvas.height / 2;
            bird.velocity = 0;
            bird.rotation = 0;
            obstacles.reset();
            canvas.style.backgroundColor = "#70c5ce";
            canvas.classList.remove('scary-mode');
            document.getElementById('scoreDisplay').innerText = "SCORE: 0";
            loop();
        }

        function gameOver() {
            if (gameState === 'GAMEOVER') return;
            gameState = 'GAMEOVER';
            bird.velocity = -8; 
            document.getElementById('finalScore').innerText = score;
            document.getElementById('finalTime').innerText = survivalTime.toFixed(1) + "s";
            // ã€ä¿®æ”¹ 3ã€‘ç§»é™¤å‘¼å« updateLeaderboard
            setTimeout(() => { document.getElementById('gameOverScreen').classList.remove('hidden'); }, 1000);
        }

        function loop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            currentVolume = getVolume();
            let barHeight = Math.min(currentVolume / 255 * 100 * 3, 100);
            document.getElementById('micBar').style.height = barHeight + "%";

            if (gameState === 'PLAYING') {
                survivalTime = (Date.now() - startTime) / 1000;
                document.getElementById('timeDisplay').innerText = `â±ï¸ ${survivalTime.toFixed(1)}s`;
                bird.update();
                obstacles.update();
                obstacles.draw();
                bird.draw();
                frames++;
                requestAnimationFrame(loop);
            } else if (gameState === 'GAMEOVER') {
                bird.y += bird.velocity;
                bird.velocity += bird.gravity;
                bird.draw();
                obstacles.draw();
                if (bird.y < canvas.height + 200) requestAnimationFrame(loop);
            }
        }

        document.getElementById('startBtn').addEventListener('click', initAudio);
    </script>
</body>
</html>
