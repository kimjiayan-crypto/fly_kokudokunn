<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è²æ§åœ‹åœŸé³¥ - å®‰å…¨é£›è¡ŒæŒ‘æˆ°</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background-color: #333;
            font-family: 'Press Start 2P', cursive;
            touch-action: none;
            user-select: none;
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 100%;
            background-color: #70c5ce;
            image-rendering: pixelated;
            transition: background-color 2s ease;
        }

        /* ææ€–èƒŒæ™¯æ¨£å¼ */
        .scary-mode {
            background-color: #4a0000 !important;
            animation: shake 0.5s infinite;
        }
        @keyframes shake {
            0% { transform: translate(1px, 1px); }
            50% { transform: translate(-1px, -1px); }
            100% { transform: translate(1px, 1px); }
        }

        /* UI å±¤è¨­å®š */
        .ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .hud {
            display: flex;
            /* ä¿®æ”¹ï¼šåŸæœ¬æ˜¯ space-betweenï¼Œç¾åœ¨åªå‰©æ™‚é–“ï¼Œæ”¹ç‚ºç½®ä¸­æˆ–é å³çš†å¯ï¼Œé€™è£¡è¨­ç‚ºç½®ä¸­è®“æ™‚é–“æ›´æ˜é¡¯ */
            justify-content: center; 
            padding: 20px;
            font-size: 24px; /*ç¨å¾®åŠ å¤§ä¸€é»å­—é«”*/
            color: white;
            text-shadow: 2px 2px 0 #000;
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: white;
            z-index: 100;
            pointer-events: auto;
            padding: 20px;
            box-sizing: border-box;
        }

        .hidden {
            display: none !important;
        }

        h1 {
            line-height: 1.4;
            color: #FFD700;
            text-shadow: 4px 4px 0 #000;
            font-size: 24px;
            margin: 0 0 25px 0;
            max-width: 100%;
        }

        button {
            font-family: 'Press Start 2P', cursive;
            padding: 20px 30px;
            font-size: 18px;
            background: #ff5500;
            color: white;
            border: 4px solid #fff;
            cursor: pointer;
            box-shadow: 6px 6px 0px #000;
            margin-top: 30px;
            transition: transform 0.1s;
        }

        button:active {
            transform: translate(3px, 3px);
            box-shadow: 3px 3px 0px #000;
        }

        .assets { display: none; }
    </style>
</head>
<body>

    <div class="assets">
        <img id="img-bird" src="fly_right.png" alt="Bird">
        <img id="img-hit" src="fly_hit.png" alt="Hit">
    </div>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        
        <div class="ui-layer">
            <div class="hud">
                <span id="timeDisplay">â±ï¸ 0.0s</span>
            </div>
            <div style="position:absolute; left:20px; top:80px; width:15px; height:100px; border:2px solid white;">
                <div id="micBar" style="background:#0f0; width:100%; height:0%; position:absolute; bottom:0;"></div>
            </div>
        </div>
        
        <div id="startScreen" class="overlay">
            <h1>æ­¡è¿ä¾†åˆ°<br>ã€Šè²æ§åœ‹åœŸé³¥ã€‹<br>å®‰å…¨é£›è¡ŒæŒ‘æˆ°</h1>
            
            <p style="margin:20px 0; line-height:1.8; color: #fff;">
                å‡ºè² = å¾€ä¸Šé£›<br>
                å®‰éœ = å¾€ä¸‹å¢œ
            </p>
            
            <div style="margin: 10px 0; font-size: 14px; text-align: left; display: inline-block; max-width: 80%; line-height: 1.6;">
                <div style="color: #88ccff;">
                    è«‹æº–å‚™å¥½ä½ çš„å–‰åš¨ï¼Œ<br>
                    ç”¨è²éŸ³æ§åˆ¶åœ‹åœŸé³¥èº²é¿éšœç¤™ã€‚<br><br>
                    é–ƒé¿æ„å¤–ï¼
                </div>                  
            </div>

            <button id="startBtn">å…è¨±éº¥å…‹é¢¨ä¸¦é–‹å§‹</button>
        </div>

        <div id="gameOverScreen" class="overlay hidden">
            <h1>ğŸ‘· å·¥å®‰æ„å¤–!</h1>
            <p>æœ¬æ¬¡å­˜æ´»</p>
            <h2 id="finalTime" style="font-size: 50px; color: #fff; margin: 20px 0;">0s</h2>
            
            <button onclick="location.reload()">å†è©¦ä¸€æ¬¡</button>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒè®Šæ•¸ ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const birdImg = document.getElementById('img-bird');
        const hitImg = document.getElementById('img-hit');
        
        let audioContext, analyser, microphone, dataArray;
        let currentVolume = 0;
        let isMicReady = false;

        let gameState = 'START';
        let frames = 0;
        let startTime = 0;
        let survivalTime = 0;

        // --- éŸ¿æ‡‰å¼ç•«å¸ƒ ---
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // --- é³¥ (ç‰©ç†é‚è¼¯) ---
        const bird = {
            x: 50,
            y: 200,
            
            // ç¶­æŒå¤§é³¥è¨­å®š
            width: 100,  
            height: 100,
            
            // ç¶­æŒç¸®å°ç¢°æ’ç®±è¨­å®š (é¿å…åœ–å¤ªå¤§å®¹æ˜“æ­»)
            collisionX: 15,   
            collisionY: 15,   
            collisionWidth: 70, 
            collisionHeight: 70, 

            velocity: 0,
            gravity: 0.25,
            rotation: 0,
            
            draw: function() {
                ctx.save();
                ctx.translate(this.x + this.width/2, this.y + this.height/2);
                
                if (gameState === 'PLAYING') {
                    this.rotation = Math.min(Math.PI / 4, Math.max(-Math.PI / 4, (this.velocity * 0.1)));
                } else if (gameState === 'GAMEOVER') {
                    this.rotation += 0.3;
                }
                ctx.rotate(this.rotation);

                let renderImg = (gameState === 'GAMEOVER') ? hitImg : birdImg;
                if (renderImg.complete && renderImg.naturalHeight !== 0) {
                    ctx.drawImage(renderImg, -this.width/2, -this.height/2, this.width, this.height);
                } else {
                    ctx.fillStyle = (gameState === 'GAMEOVER') ? 'red' : 'yellow';
                    ctx.fillRect(-this.width/2, -this.height/2, this.width, this.height);
                }
                ctx.restore();
            },

            update: function() {
                this.velocity += this.gravity;
                this.y += this.velocity;

                if (this.y + this.height >= canvas.height) {
                    this.y = canvas.height - this.height;
                    gameOver();
                }
                if (this.y < 0) {
                    this.y = 0;
                    this.velocity = 0;
                }

                // è²æ§é–¾å€¼ (ç¶­æŒéˆæ•åº¦)
                let threshold = 40; 

                if (currentVolume > threshold) {
                    let intensity = (currentVolume - threshold) / (255 - threshold);
                    let boost = intensity * 4.0; 
                    this.velocity = -4.0 - boost;
                }
            }
        };

        // --- éšœç¤™ç‰© ---
        const obstacles = {
            list: [],
            gap: 260, 
            dx: 3, 

            draw: function() {
                for (let i = 0; i < this.list.length; i++) {
                    let p = this.list[i];
                    
                    ctx.fillStyle = (survivalTime > 60) ? '#000' : '#555'; 

                    // ç¹ªè£½ä¸Šç®¡
                    if (p.easyType !== 'bottomOnly') {
                        ctx.fillRect(p.x, 0, p.w, p.top);
                        ctx.fillStyle = '#333';
                        ctx.fillRect(p.x + 10, 0, 5, p.top);
                        ctx.fillRect(p.x + p.w - 15, 0, 5, p.top);
                        ctx.fillStyle = (survivalTime > 60) ? '#000' : '#555';
                    }

                    // ç¹ªè£½ä¸‹ç®¡
                    if (p.easyType !== 'topOnly') {
                        ctx.fillRect(p.x, canvas.height - p.bottom, p.w, p.bottom);
                        ctx.fillStyle = '#333';
                        ctx.fillRect(p.x + 10, canvas.height - p.bottom, 5, p.bottom);
                        ctx.fillRect(p.x + p.w - 15, canvas.height - p.bottom, 5, p.bottom);
                    }
                }
            },

            update: function() {
                let frameInterval;
                let posRange; 
                let isEasyMode = false;

                // é›£åº¦æ›²ç·š
                if (survivalTime < 8) {
                    this.dx = 3;
                    this.gap = 400; 
                    frameInterval = 200; 
                    posRange = canvas.height * 0.1;
                    isEasyMode = true;
                } else if (survivalTime < 15) {
                    this.dx = 3;          
                    this.gap = 260; 
                    frameInterval = 180;  
                    posRange = canvas.height * 0.1; 
                } else if (survivalTime < 30) {
                    this.dx = 4;
                    this.gap = 250; 
                    frameInterval = 140;
                    posRange = canvas.height * 0.2;
                } else if (survivalTime < 60) {
                    this.dx = 5;
                    this.gap = 220; 
                    frameInterval = 100;
                    posRange = canvas.height * 0.35;
                    canvas.style.backgroundColor = "#e6a65c";
                } else {
                    this.dx = 7;
                    this.gap = 200; 
                    frameInterval = 80;
                    posRange = canvas.height * 0.4;
                    canvas.classList.add('scary-mode');
                }

                if (frames % frameInterval === 0) {
                    let center = canvas.height / 2;
                    let topHeight = center - (this.gap / 2) + (Math.random() - 0.5) * posRange;

                    let minPipe = 50;
                    if (topHeight < minPipe) topHeight = minPipe;
                    if (topHeight > canvas.height - this.gap - minPipe) topHeight = canvas.height - this.gap - minPipe;

                    let obstacleData = {
                        x: canvas.width,
                        w: 70,
                        top: topHeight,
                        bottom: canvas.height - (topHeight + this.gap),
                        easyType: null 
                    };

                    if (isEasyMode) {
                        obstacleData.easyType = Math.random() < 0.5 ? 'topOnly' : 'bottomOnly';
                    }

                    this.list.push(obstacleData);
                }

                for (let i = 0; i < this.list.length; i++) {
                    let p = this.list[i];
                    p.x -= this.dx;

                    // ç¢°æ’åµæ¸¬ (ä½¿ç”¨ collisionBox)
                    let birdBox = {
                        x: bird.x + bird.collisionX,
                        y: bird.y + bird.collisionY,
                        width: bird.collisionWidth,
                        height: bird.collisionHeight
                    };

                    if (p.easyType !== 'bottomOnly' && birdBox.x + birdBox.width > p.x && birdBox.x < p.x + p.w && birdBox.y < p.top) gameOver();
                    if (p.easyType !== 'topOnly' && birdBox.x + birdBox.width > p.x && birdBox.x < p.x + p.w && birdBox.y + birdBox.height > canvas.height - p.bottom) gameOver();

                    if (p.x + p.w < 0) {
                        this.list.shift();
                        // ä¿®æ”¹ï¼šä¸å†æ›´æ–° scoreDisplay
                    }
                }
            },
            reset: function() { this.list = []; }
        };

        // --- ç³»çµ±åŠŸèƒ½ ---
        async function initAudio() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);
                analyser.fftSize = 256;
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                isMicReady = true;
                startGame();
            } catch (err) {
                alert("ç„¡æ³•å•Ÿç”¨éº¥å…‹é¢¨ï¼è«‹ç¢ºèªæ¬Šé™ã€‚");
            }
        }

        function getVolume() {
            if (!analyser) return 0;
            analyser.getByteFrequencyData(dataArray);
            let sum = 0;
            for(let i = 0; i < dataArray.length; i++) sum += dataArray[i];
            return sum / dataArray.length; 
        }

        function startGame() {
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('gameOverScreen').classList.add('hidden');
            gameState = 'PLAYING';
            frames = 0;
            survivalTime = 0;
            startTime = Date.now();
            bird.y = canvas.height / 2;
            bird.velocity = 0;
            bird.rotation = 0;
            obstacles.reset();
            canvas.style.backgroundColor = "#70c5ce";
            canvas.classList.remove('scary-mode');
            // ä¿®æ”¹ï¼šä¸å†é‡ç½® Score æ–‡å­—
            loop();
        }

        function gameOver() {
            if (gameState === 'GAMEOVER') return;
            gameState = 'GAMEOVER';
            bird.velocity = -8; 
            // ä¿®æ”¹ï¼šç§»é™¤äº† finalScore çš„æ›´æ–°
            document.getElementById('finalTime').innerText = survivalTime.toFixed(1) + "s";
            setTimeout(() => { document.getElementById('gameOverScreen').classList.remove('hidden'); }, 1000);
        }

        function loop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            currentVolume = getVolume();
            let barHeight = Math.min(currentVolume / 255 * 100 * 3, 100);
            document.getElementById('micBar').style.height = barHeight + "%";

            if (gameState === 'PLAYING') {
                survivalTime = (Date.now() - startTime) / 1000;
                document.getElementById('timeDisplay').innerText = `â±ï¸ ${survivalTime.toFixed(1)}s`;
                bird.update();
                obstacles.update();
                obstacles.draw();
                bird.draw();
                frames++;
                requestAnimationFrame(loop);
            } else if (gameState === 'GAMEOVER') {
                bird.y += bird.velocity;
                bird.velocity += bird.gravity;
                bird.draw();
                obstacles.draw();
                if (bird.y < canvas.height + 200) requestAnimationFrame(loop);
            }
        }

        document.getElementById('startBtn').addEventListener('click', initAudio);
    </script>
</body>
</html>
