<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è²æ§åœ‹åœŸé³¥ - å®‰å…¨é£›è¡ŒæŒ‘æˆ°</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background-color: #333;
            font-family: 'Press Start 2P', cursive;
            touch-action: none;
            user-select: none;
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 100%;
            background-color: #70c5ce; /* åˆå§‹å¤©ç©ºè— */
            image-rendering: pixelated;
            transition: background-color 2s ease;
        }

        /* ææ€–èƒŒæ™¯æ¨£å¼ */
        .scary-mode {
            background-color: #4a0000 !important;
            animation: shake 0.5s infinite;
        }
        @keyframes shake {
            0% { transform: translate(1px, 1px); }
            50% { transform: translate(-1px, -1px); }
            100% { transform: translate(1px, 1px); }
        }

        /* UI å±¤è¨­å®š */
        .ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .hud {
            display: flex;
            justify-content: space-between;
            padding: 20px;
            font-size: 20px;
            color: white;
            text-shadow: 2px 2px 0 #000;
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: white;
            z-index: 100;
            pointer-events: auto;
        }

        .hidden {
            display: none !important;
        }

        h1 {
            line-height: 1.5;
            color: #FFD700;
            text-shadow: 4px 4px 0 #000;
            font-size: 32px;
        }

        button {
            font-family: 'Press Start 2P', cursive;
            padding: 20px 30px;
            font-size: 18px;
            background: #ff5500;
            color: white;
            border: 4px solid #fff;
            cursor: pointer;
            box-shadow: 6px 6px 0px #000;
            margin-top: 20px;
            transition: transform 0.1s;
        }

        button:active {
            transform: translate(3px, 3px);
            box-shadow: 3px 3px 0px #000;
        }

        /* æ’è¡Œæ¦œæ¨£å¼ */
        #leaderboard {
            margin-top: 20px;
            text-align: left;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border: 2px solid #fff;
            width: 80%;
            max-width: 300px;
        }
        .rank-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
            color: #ccc;
        }
        .rank-item.top { color: #FFD700; }

        .assets { display: none; }
    </style>
</head>
<body>

    <div class="assets">
        <img id="img-bird" src="fly_right.png" alt="Bird">
        <img id="img-hit" src="fly_hit.png" alt="Hit">
    </div>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        
        <div class="ui-layer">
            <div class="hud">
                <span id="scoreDisplay">SCORE: 0</span>
                <span id="timeDisplay">â±ï¸ 0.0s</span>
            </div>
            <div style="position:absolute; left:20px; top:80px; width:15px; height:100px; border:2px solid white;">
                <div id="micBar" style="background:#0f0; width:100%; height:0%; position:absolute; bottom:0;"></div>
            </div>
        </div>
        
        <div id="startScreen" class="overlay">
            <h1> æ­¡è¿ä¾†åˆ° ã€Šè²æ§åœ‹åœŸé³¥ï¼šå®‰å…¨é£›è¡ŒæŒ‘æˆ°ã€‹ã€‚  <br></h1>
            <p style="margin:20px 0; line-height:1.8;">
                å¤§å« = å¾€ä¸Šé£›<br>
                å®‰éœ = å¾€ä¸‹å¢œ
            </p>
            
            <div style="margin: 20px 0; font-size: 16px; text-align: left; display: inline-block;">
                <div style="color: #88ccff;">åœ¨é€™å€‹ä¸–ç•Œè£¡ï¼Œ<br>
                    ä½ ä¸æ˜¯é£›è¡Œå“¡ã€ä¸æ˜¯å·¥ç¨‹å¸«ï¼Œ<br>
                    ä½ æ˜¯ä¸€éš»å¿…é ˆé å¤§å¼å¤§å«æ‰èƒ½ç¶­æŒé£›è¡Œçš„é³¥ã€‚<br>
                    æ²’éŒ¯ï¼Œ<br>
                    ä½ æ˜¯ä¸€éš»é©•å‚²çš„åœ‹åœŸé³¥ã€‚ </p>               
            </div>

            <button id="startBtn">å…è¨±éº¥å…‹é¢¨ä¸¦é–‹å§‹</button>
        </div>

        <div id="gameOverScreen" class="overlay hidden">
            <h1>ğŸ‘· å·¥å®‰æ„å¤–!</h1>
            <p>æœ¬æ¬¡å­˜æ´»</p>
            <h2 id="finalTime" style="font-size: 40px; color: #fff; margin: 10px 0;">0s</h2>
            <p>æœ¬æ¬¡å¾—åˆ†</p>
            <h2 id="finalScore" style="font-size: 50px; color: #FFD700; margin: 10px 0;">0</h2>
            
            <div id="leaderboard">
                <div style="text-align:center; margin-bottom:10px; text-decoration:underline;">ğŸ† è‹±é›„æ¦œ (Top 5)</div>
                <div id="rankList"></div>
            </div>

            <button onclick="location.reload()">å†è©¦ä¸€æ¬¡</button>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒè®Šæ•¸ ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const birdImg = document.getElementById('img-bird');
        const hitImg = document.getElementById('img-hit');
        
        let audioContext, analyser, microphone, dataArray;
        let currentVolume = 0;
        let isMicReady = false;

        let gameState = 'START';
        let frames = 0;
        let score = 0;
        let startTime = 0;
        let survivalTime = 0;

        // --- éŸ¿æ‡‰å¼ç•«å¸ƒ ---
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // --- é³¥ (ç‰©ç†é‚è¼¯ï¼šå®Œå…¨ä¸åšä»»ä½•å‹•æ…‹èª¿æ•´) ---
        const bird = {
            x: 50,
            y: 200,
            width: 50,
            height: 50,
            velocity: 0,
            gravity: 0.25,      // å›ºå®šé‡åŠ›
            jumpStrength: -5.0, // å›ºå®šè·³èºåŠ›
            rotation: 0,
            
            draw: function() {
                ctx.save();
                ctx.translate(this.x + this.width/2, this.y + this.height/2);
                
                if (gameState === 'PLAYING') {
                    this.rotation = Math.min(Math.PI / 4, Math.max(-Math.PI / 4, (this.velocity * 0.1)));
                } else if (gameState === 'GAMEOVER') {
                    this.rotation += 0.3;
                }
                ctx.rotate(this.rotation);

                let renderImg = (gameState === 'GAMEOVER') ? hitImg : birdImg;
                if (renderImg.complete && renderImg.naturalHeight !== 0) {
                    ctx.drawImage(renderImg, -this.width/2, -this.height/2, this.width, this.height);
                } else {
                    ctx.fillStyle = (gameState === 'GAMEOVER') ? 'red' : 'yellow';
                    ctx.fillRect(-this.width/2, -this.height/2, this.width, this.height);
                }
                ctx.restore();
            },

            update: function() {
                // âš ï¸ é‡åŠ›ä¸å†éš¨æ™‚é–“è®ŠåŒ–ï¼Œä¿æŒæ‰‹æ„Ÿä¸€è‡´
                this.velocity += this.gravity;
                this.y += this.velocity;

                if (this.y + this.height >= canvas.height) {
                    this.y = canvas.height - this.height;
                    gameOver();
                }
                if (this.y < 0) {
                    this.y = 0;
                    this.velocity = 0;
                }

                // è²æ§é–¾å€¼ (åƒ…ä¿ç•™æœ€åŸºæœ¬çš„æ•æ„Ÿåº¦èª¿æ•´ï¼Œä¸å½±éŸ¿ç‰©ç†)
                // ç‚ºäº†é˜²æ­¢é›œéŸ³ï¼Œç¶­æŒä¸€å€‹åŸºæœ¬çš„é–€æª»
                let threshold = 15; 

                if (currentVolume > threshold) {
                    let boost = (currentVolume / 255) * 2;
                    this.velocity = this.jumpStrength - boost;
                }
            }
        };

        // --- éšœç¤™ç‰© (æ ¸å¿ƒä¿®æ”¹å€) ---
        const obstacles = {
            list: [],
            gap: 200, 
            dx: 3, 

            draw: function() {
                for (let i = 0; i < this.list.length; i++) {
                    let p = this.list[i];
                    
                    ctx.fillStyle = (survivalTime > 60) ? '#000' : '#555'; 

                    // ä¸Šç®¡
                    ctx.fillRect(p.x, 0, p.w, p.top);
                    // ä¸‹ç®¡
                    ctx.fillRect(p.x, canvas.height - p.bottom, p.w, p.bottom);
                    
                    // è£é£¾
                    ctx.fillStyle = '#333';
                    ctx.fillRect(p.x + 10, 0, 5, p.top);
                    ctx.fillRect(p.x + p.w - 15, 0, 5, p.top);
                    ctx.fillRect(p.x + 10, canvas.height - p.bottom, 5, p.bottom);
                    ctx.fillRect(p.x + p.w - 15, canvas.height - p.bottom, 5, p.bottom);
                }
            },

            update: function() {
                // âœ… 1. æ–°æ‰‹ä¿è­·æœŸï¼šå‰ 8 ç§’å®Œå…¨ä¸ç”Ÿæˆéšœç¤™
                // è®“ç©å®¶æœ‰æ™‚é–“é©æ‡‰éº¥å…‹é¢¨å’Œé³¥çš„é‡é‡
                if (survivalTime < 8) {
                    // åªç§»å‹•ç¾æœ‰çš„ï¼ˆé›–ç„¶é–‹å±€æ²’æœ‰ï¼‰ï¼Œä¸ç”Ÿæˆæ–°çš„
                } 
                else {
                    // âœ… 2. é›£åº¦æ›²ç·šè¨­è¨ˆ
                    let frameInterval;
                    let posRange; // ç”¨ä¾†æ§åˆ¶éš¨æ©Ÿç¯„åœ (æ•¸å€¼è¶Šå°è¶Šé›†ä¸­åœ¨ä¸­é–“)

                    if (survivalTime < 15) {
                        // æ–°æ‰‹æœŸ (8-15s)ï¼šè¶…ç´šç°¡å–®
                        this.dx = 3;          // æ…¢é€Ÿ
                        this.gap = 260;       // âœ… ç¸«éš™è¶…å¤§ (åŸæœ¬200)
                        frameInterval = 180;  // âœ… ç”Ÿæˆé–“éš”å¾ˆä¹… (çµ¦åæ‡‰æ™‚é–“)
                        posRange = canvas.height * 0.1; // âœ… é«˜åº¦å¹¾ä¹é–å®šåœ¨ä¸­é–“
                    } else if (survivalTime < 30) {
                        // ç†±èº«æœŸ (15-30s)ï¼šç¨å¾®ç¸®ç·Š
                        this.dx = 4;
                        this.gap = 220;
                        frameInterval = 140;
                        posRange = canvas.height * 0.2;
                    } else if (survivalTime < 60) {
                        // æ­£å¸¸æœŸ (30-60s)
                        this.dx = 5;
                        this.gap = 170;
                        frameInterval = 100;
                        posRange = canvas.height * 0.35; // æ¢å¾©æ­£å¸¸éš¨æ©Ÿ
                        canvas.style.backgroundColor = "#e6a65c";
                    } else {
                        // åœ°ç„æ¨¡å¼ (60s+)
                        this.dx = 7;
                        this.gap = 150;
                        frameInterval = 80;
                        posRange = canvas.height * 0.4;
                        canvas.classList.add('scary-mode');
                    }

                    // ç”Ÿæˆé‚è¼¯
                    if (frames % frameInterval === 0) {
                        let center = canvas.height / 2;
                        // è¨ˆç®—ä¸Šç®¡é•·åº¦ï¼šä¸­å¿ƒé» - åŠå€‹ç¸«éš™ + éš¨æ©Ÿåç§»
                        let topHeight = center - (this.gap / 2) + (Math.random() - 0.5) * posRange;

                        // é¿å…ç®¡å­å¤ªçŸ­æˆ–å¤ªé•·
                        let minPipe = 50;
                        if (topHeight < minPipe) topHeight = minPipe;
                        if (topHeight > canvas.height - this.gap - minPipe) topHeight = canvas.height - this.gap - minPipe;

                        this.list.push({
                            x: canvas.width,
                            w: 70,
                            top: topHeight,
                            bottom: canvas.height - (topHeight + this.gap)
                        });
                    }
                }

                // ç§»å‹•èˆ‡ç¢°æ’ (æ‰€æœ‰éšæ®µéƒ½åŸ·è¡Œ)
                for (let i = 0; i < this.list.length; i++) {
                    let p = this.list[i];
                    p.x -= this.dx;

                    // ç¢°æ’åˆ¤å®š
                    if (bird.x + bird.width > p.x && bird.x < p.x + p.w && bird.y < p.top) gameOver();
                    if (bird.x + bird.width > p.x && bird.x < p.x + p.w && bird.y + bird.height > canvas.height - p.bottom) gameOver();

                    // åŠ åˆ†èˆ‡ç§»é™¤
                    if (p.x + p.w < 0) {
                        this.list.shift();
                        score++;
                        document.getElementById('scoreDisplay').innerText = "SCORE: " + score;
                    }
                }
            },
            reset: function() { this.list = []; }
        };

        // --- ç³»çµ±åŠŸèƒ½ ---
        async function initAudio() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);
                analyser.fftSize = 256;
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                isMicReady = true;
                startGame();
            } catch (err) {
                alert("ç„¡æ³•å•Ÿç”¨éº¥å…‹é¢¨ï¼è«‹ç¢ºèªæ¬Šé™ã€‚");
            }
        }

        function getVolume() {
            if (!analyser) return 0;
            analyser.getByteFrequencyData(dataArray);
            let sum = 0;
            for(let i = 0; i < dataArray.length; i++) sum += dataArray[i];
            return sum / dataArray.length; 
        }

        function updateLeaderboard(finalScore) {
            let highScores = JSON.parse(localStorage.getItem('birdHighScores')) || [];
            let date = new Date();
            let timeStr = `${date.getHours()}:${date.getMinutes()}`;
            highScores.push({ score: finalScore, date: timeStr });
            highScores.sort((a, b) => b.score - a.score);
            highScores = highScores.slice(0, 5);
            localStorage.setItem('birdHighScores', JSON.stringify(highScores));
            
            let listHTML = '';
            highScores.forEach((item, index) => {
                let rankClass = (index === 0) ? 'top' : '';
                let medal = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰','4ï¸âƒ£','5ï¸âƒ£'][index] || '';
                listHTML += `<div class="rank-item ${rankClass}"><span>${medal} ${item.date}</span><span>${item.score}åˆ†</span></div>`;
            });
            document.getElementById('rankList').innerHTML = listHTML;
        }

        function startGame() {
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('gameOverScreen').classList.add('hidden');
            gameState = 'PLAYING';
            score = 0;
            frames = 0;
            survivalTime = 0;
            startTime = Date.now();
            bird.y = canvas.height / 2;
            bird.velocity = 0;
            bird.rotation = 0;
            obstacles.reset();
            canvas.style.backgroundColor = "#70c5ce";
            canvas.classList.remove('scary-mode');
            document.getElementById('scoreDisplay').innerText = "SCORE: 0";
            loop();
        }

        function gameOver() {
            if (gameState === 'GAMEOVER') return;
            gameState = 'GAMEOVER';
            bird.velocity = -8; 
            document.getElementById('finalScore').innerText = score;
            document.getElementById('finalTime').innerText = survivalTime.toFixed(1) + "s";
            updateLeaderboard(score);
            setTimeout(() => { document.getElementById('gameOverScreen').classList.remove('hidden'); }, 1000);
        }

        function loop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            currentVolume = getVolume();
            let barHeight = Math.min(currentVolume / 255 * 100 * 3, 100);
            document.getElementById('micBar').style.height = barHeight + "%";

            if (gameState === 'PLAYING') {
                survivalTime = (Date.now() - startTime) / 1000;
                document.getElementById('timeDisplay').innerText = `â±ï¸ ${survivalTime.toFixed(1)}s`;
                bird.update();
                obstacles.update();
                obstacles.draw();
                bird.draw();
                frames++;
                requestAnimationFrame(loop);
            } else if (gameState === 'GAMEOVER') {
                bird.y += bird.velocity;
                bird.velocity += bird.gravity;
                bird.draw();
                obstacles.draw();
                if (bird.y < canvas.height + 200) requestAnimationFrame(loop);
            }
        }

        document.getElementById('startBtn').addEventListener('click', initAudio);
    </script>
</body>
</html>


