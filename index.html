<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è²æ§å·¥åœ°é³¥ - æ¥µé™ç”Ÿå­˜æŒ‘æˆ°</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background-color: #333;
            font-family: 'Press Start 2P', cursive;
            touch-action: none;
            user-select: none;
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 100%;
            background-color: #70c5ce; /* åˆå§‹å¤©ç©ºè— */
            image-rendering: pixelated;
            transition: background-color 2s ease; /* èƒŒæ™¯è®Šè‰²è½‰å ´ */
        }

        /* ææ€–èƒŒæ™¯æ¨£å¼ */
        .scary-mode {
            background-color: #4a0000 !important; /* è¡€ç´…è‰² */
            animation: shake 0.5s infinite;
        }
        @keyframes shake {
            0% { transform: translate(1px, 1px); }
            50% { transform: translate(-1px, -1px); }
            100% { transform: translate(1px, 1px); }
        }

        /* UI å±¤è¨­å®š */
        .ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .hud {
            display: flex;
            justify-content: space-between;
            padding: 20px;
            font-size: 20px;
            color: white;
            text-shadow: 2px 2px 0 #000;
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: white;
            z-index: 100;
            pointer-events: auto;
        }

        .hidden {
            display: none !important;
        }

        h1 {
            line-height: 1.5;
            color: #FFD700;
            text-shadow: 4px 4px 0 #000;
            font-size: 32px;
        }

        button {
            font-family: 'Press Start 2P', cursive;
            padding: 20px 30px;
            font-size: 18px;
            background: #ff5500;
            color: white;
            border: 4px solid #fff;
            cursor: pointer;
            box-shadow: 6px 6px 0px #000;
            margin-top: 20px;
            transition: transform 0.1s;
        }

        button:active {
            transform: translate(3px, 3px);
            box-shadow: 3px 3px 0px #000;
        }

        /* æ’è¡Œæ¦œæ¨£å¼ */
        #leaderboard {
            margin-top: 20px;
            text-align: left;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border: 2px solid #fff;
            width: 80%;
            max-width: 300px;
        }
        .rank-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
            color: #ccc;
        }
        .rank-item.top { color: #FFD700; }

        .assets { display: none; }
    </style>
</head>
<body>

    <div class="assets">
        <img id="img-bird" src="fly_right.jpg" alt="Bird">
        <img id="img-hit" src="fly_hit.jpg" alt="Hit">
        <audio id="bgm" src="bgm.mp3" loop></audio>
    </div>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        
        <div class="ui-layer">
            <div class="hud">
                <span id="scoreDisplay">SCORE: 0</span>
                <span id="timeDisplay">â±ï¸ 0.0s</span>
            </div>
            <div style="position:absolute; left:20px; top:80px; width:15px; height:100px; border:2px solid white;">
                <div id="micBar" style="background:#0f0; width:100%; height:0%; position:absolute; bottom:0;"></div>
            </div>
        </div>
        
        <div id="startScreen" class="overlay">
            <h1>ğŸ—ï¸ è²æ§å·¥åœ°é³¥<br>æ¥µé™ç”Ÿå­˜</h1>
            <p style="margin:20px 0; line-height:1.8;">
                å°éº¥å…‹é¢¨å¤§å« = å¾€ä¸Šé£›<br>
                å°è² = æ‡¸åœ / é–‰å˜´ = ä¸‹å¢œ
            </p>
            
            <div style="margin: 20px 0; font-size: 16px; text-align: left; display: inline-block;">
                <div style="color: #88ccff;">ğŸ”¹ 0-15s: æš–èº« (ç”¨åŠ›å–Š!)</div>
                <div style="color: #ffcc00;">ğŸ”¸ 15-60s: éšœç¤™åŠ é€Ÿ</div>
                <div style="color: #ff4444;">ğŸ’€ 60s+: åœ°ç„æ¨¡å¼</div>
            </div>

            <button id="startBtn">å…è¨±éº¥å…‹é¢¨ä¸¦é–‹å§‹</button>
            <p style="font-size: 12px; margin-top: 20px; color: #aaa;">(å»ºè­°ä½¿ç”¨è€³æ©ŸéŠç©)</p>
        </div>

        <div id="gameOverScreen" class="overlay hidden">
            <h1>ğŸ‘· å·¥å®‰æ„å¤–!</h1>
            <p>æœ¬æ¬¡å­˜æ´»</p>
            <h2 id="finalTime" style="font-size: 40px; color: #fff; margin: 10px 0;">0s</h2>
            <p>æœ¬æ¬¡å¾—åˆ†</p>
            <h2 id="finalScore" style="font-size: 50px; color: #FFD700; margin: 10px 0;">0</h2>
            
            <div id="leaderboard">
                <div style="text-align:center; margin-bottom:10px; text-decoration:underline;">ğŸ† è‹±é›„æ¦œ (Top 5)</div>
                <div id="rankList"></div>
            </div>

            <button onclick="location.reload()">å†è©¦ä¸€æ¬¡</button>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒè®Šæ•¸ ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const birdImg = document.getElementById('img-bird');
        const hitImg = document.getElementById('img-hit');
        const bgm = document.getElementById('bgm');
        
        // éº¥å…‹é¢¨èˆ‡éŸ³è¨Š
        let audioContext, analyser, microphone, dataArray;
        let currentVolume = 0;
        let isMicReady = false;

        // éŠæˆ²ç‹€æ…‹
        let gameState = 'START'; // START, PLAYING, GAMEOVER
        let frames = 0;
        let score = 0;
        let startTime = 0;
        let survivalTime = 0;
        let difficultyLevel = 1;

        // --- éŸ¿æ‡‰å¼ç•«å¸ƒ ---
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // --- é³¥ (ä¸»è§’) ---
        const bird = {
            x: 50,
            y: 200,
            width: 50,
            height: 50,
            velocity: 0,
            gravity: 0.25,      // é è¨­é‡åŠ›
            jumpStrength: -5.0, // é è¨­è·³èºåŠ›
            rotation: 0,
            
            draw: function() {
                ctx.save();
                ctx.translate(this.x + this.width/2, this.y + this.height/2);
                
                if (gameState === 'PLAYING') {
                    this.rotation = Math.min(Math.PI / 4, Math.max(-Math.PI / 4, (this.velocity * 0.1)));
                } else if (gameState === 'GAMEOVER') {
                    this.rotation += 0.3; // å¢œè½æ—‹è½‰
                }
                ctx.rotate(this.rotation);

                let renderImg = (gameState === 'GAMEOVER') ? hitImg : birdImg;
                if (renderImg.complete && renderImg.naturalHeight !== 0) {
                    ctx.drawImage(renderImg, -this.width/2, -this.height/2, this.width, this.height);
                } else {
                    ctx.fillStyle = (gameState === 'GAMEOVER') ? 'red' : 'yellow';
                    ctx.fillRect(-this.width/2, -this.height/2, this.width, this.height);
                }
                ctx.restore();
            },

            update: function() {
                // æ ¹æ“šé›£åº¦èª¿æ•´é‡åŠ›æ‰‹æ„Ÿ
                // Level 1 (0-15s): é‡åŠ›å¤§ï¼Œè¦ç”¨åŠ›å–Š
                if (survivalTime < 15) {
                    this.gravity = 0.35; 
                } else {
                    this.gravity = 0.25; // æ¢å¾©æ­£å¸¸
                }

                this.velocity += this.gravity;
                this.y += this.velocity;

                // åœ°æ¿èˆ‡å¤©èŠ±æ¿
                if (this.y + this.height >= canvas.height) {
                    this.y = canvas.height - this.height;
                    gameOver();
                }
                if (this.y < 0) {
                    this.y = 0;
                    this.velocity = 0;
                }

                // è²æ§é‚è¼¯
                // 0-15ç§’ éœ€è¦è¼ƒå¤§è²éŸ³ (Threshold = 30)
                // 15ç§’å¾Œ æ¢å¾©éˆæ• (Threshold = 15)
                let threshold = (survivalTime < 15) ? 30 : 15;

                if (currentVolume > threshold) {
                    let boost = (currentVolume / 255) * 2;
                    this.velocity = this.jumpStrength - boost;
                }
            }
        };

        // --- éšœç¤™ç‰© ---
        const obstacles = {
            list: [],
            gap: 200, 
            dx: 3, // ç§»å‹•é€Ÿåº¦

            draw: function() {
                for (let i = 0; i < this.list.length; i++) {
                    let p = this.list[i];
                    
                    // æ ¹æ“šé›£åº¦æ”¹è®Šéšœç¤™ç‰©é¡è‰²
                    ctx.fillStyle = (survivalTime > 60) ? '#000' : '#555'; 

                    // ä¸Šç®¡
                    ctx.fillRect(p.x, 0, p.w, p.top);
                    // ä¸‹ç®¡
                    ctx.fillRect(p.x, canvas.height - p.bottom, p.w, p.bottom);
                    
                    // è£é£¾
                    ctx.fillStyle = (survivalTime > 60) ? '#333' : '#333';
                    ctx.fillRect(p.x + 10, 0, 5, p.top);
                    ctx.fillRect(p.x + p.w - 15, 0, 5, p.top);
                    ctx.fillRect(p.x + 10, canvas.height - p.bottom, 5, p.bottom);
                    ctx.fillRect(p.x + p.w - 15, canvas.height - p.bottom, 5, p.bottom);
                }
            },

            update: function() {
                // --- é›£åº¦æ§åˆ¶æ ¸å¿ƒ ---
                // ç”Ÿæˆé »ç‡
                let frameInterval = 120; 
                
                if (survivalTime < 30) {
                    // ç¬¬ä¸€é—œ & æš–èº«
                    this.dx = 3;       // æ…¢é€Ÿ
                    this.gap = 200;    // å¯¬ç¸«éš™
                } else if (survivalTime < 60) {
                    // ç¬¬äºŒé—œ
                    this.dx = 5;       // åŠ é€Ÿ
                    this.gap = 170;    // ç¸«éš™è®Šçª„
                    frameInterval = 100;
                    canvas.style.backgroundColor = "#e6a65c"; // é»ƒæ˜è‰²
                } else {
                    // é­”ç‹é—œ (60s+)
                    this.dx = 7;       // æ¥µé€Ÿ
                    this.gap = 150;    // æ¥µçª„
                    frameInterval = 80;
                    canvas.classList.add('scary-mode'); // ææ€–èƒŒæ™¯
                }

                if (frames % frameInterval === 0) {
                    let topHeight = Math.random() * (canvas.height / 2);
                    let minHeight = 50;
                    if (topHeight < minHeight) topHeight = minHeight;

                    this.list.push({
                        x: canvas.width,
                        w: 70,
                        top: topHeight,
                        bottom: canvas.height - (topHeight + this.gap)
                    });
                }

                for (let i = 0; i < this.list.length; i++) {
                    let p = this.list[i];
                    p.x -= this.dx;

                    // ç¢°æ’
                    if (bird.x + bird.width > p.x && bird.x < p.x + p.w && bird.y < p.top) gameOver();
                    if (bird.x + bird.width > p.x && bird.x < p.x + p.w && bird.y + bird.height > canvas.height - p.bottom) gameOver();

                    // åŠ åˆ†
                    if (p.x + p.w < 0) {
                        this.list.shift();
                        score++;
                        document.getElementById('scoreDisplay').innerText = "SCORE: " + score;
                    }
                }
            },
            reset: function() { this.list = []; }
        };

        // --- éº¥å…‹é¢¨ç³»çµ± ---
        async function initAudio() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);
                analyser.fftSize = 256;
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                
                isMicReady = true;
                startGame();
            } catch (err) {
                alert("ç„¡æ³•å•Ÿç”¨éº¥å…‹é¢¨ï¼è«‹ç¢ºèªæ¬Šé™æˆ–ä½¿ç”¨ HTTPS é€£ç·šã€‚");
            }
        }

        function getVolume() {
            if (!analyser) return 0;
            analyser.getByteFrequencyData(dataArray);
            let sum = 0;
            for(let i = 0; i < dataArray.length; i++) sum += dataArray[i];
            return sum / dataArray.length; // 0 ~ 255
        }

        // --- æ’è¡Œæ¦œ (LocalStorage) ---
        function updateLeaderboard(finalScore) {
            let highScores = JSON.parse(localStorage.getItem('birdHighScores')) || [];
            
            // å–å¾—ç¾åœ¨æ™‚é–“å­—ä¸²
            let date = new Date();
            let timeStr = `${date.getHours()}:${date.getMinutes()}`;
            
            // åŠ å…¥æ–°åˆ†æ•¸
            highScores.push({ score: finalScore, date: timeStr });
            
            // æ’åº (é«˜åˆ†åœ¨å‰)
            highScores.sort((a, b) => b.score - a.score);
            
            // å–å‰ 5 å
            highScores = highScores.slice(0, 5);
            
            // å­˜å›å»
            localStorage.setItem('birdHighScores', JSON.stringify(highScores));
            
            // é¡¯ç¤ºåœ¨ UI
            let listHTML = '';
            highScores.forEach((item, index) => {
                let rankClass = (index === 0) ? 'top' : '';
                let medal = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰','4ï¸âƒ£','5ï¸âƒ£'][index] || '';
                listHTML += `
                    <div class="rank-item ${rankClass}">
                        <span>${medal} ${item.date}</span>
                        <span>${item.score}åˆ†</span>
                    </div>
                `;
            });
            document.getElementById('rankList').innerHTML = listHTML;
        }

        // --- éŠæˆ²æµç¨‹ ---
        function startGame() {
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('gameOverScreen').classList.add('hidden');
            
            gameState = 'PLAYING';
            score = 0;
            frames = 0;
            survivalTime = 0;
            startTime = Date.now();
            
            bird.y = canvas.height / 2;
            bird.velocity = 0;
            bird.rotation = 0;
            obstacles.reset();
            
            // é‡ç½®èƒŒæ™¯
            canvas.style.backgroundColor = "#70c5ce";
            canvas.classList.remove('scary-mode');

            document.getElementById('scoreDisplay').innerText = "SCORE: 0";
            
            // å˜—è©¦æ’­æ”¾éŸ³æ¨‚
            bgm.volume = 0.5;
            bgm.currentTime = 0;
            bgm.play().catch(e => console.log("BGM play failed (needs interaction):", e));

            loop();
        }

        function gameOver() {
            if (gameState === 'GAMEOVER') return;
            gameState = 'GAMEOVER';
            bgm.pause(); // åœæ­¢éŸ³æ¨‚
            
            // é³¥æ’é£›æ•ˆæœ
            bird.velocity = -8; 

            // é¡¯ç¤ºçµç®—
            document.getElementById('finalScore').innerText = score;
            document.getElementById('finalTime').innerText = survivalTime.toFixed(1) + "s";
            
            // æ›´æ–°æ’è¡Œæ¦œ
            updateLeaderboard(score);

            setTimeout(() => {
                document.getElementById('gameOverScreen').classList.remove('hidden');
            }, 1000);
        }

        function loop() {
            // æ¸…é™¤ç•«å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // å–å¾—éŸ³é‡
            currentVolume = getVolume();
            
            // æ›´æ–° UI éŸ³é‡æ¢
            let barHeight = Math.min(currentVolume / 255 * 100 * 3, 100);
            document.getElementById('micBar').style.height = barHeight + "%";

            if (gameState === 'PLAYING') {
                // æ›´æ–°æ™‚é–“
                survivalTime = (Date.now() - startTime) / 1000;
                document.getElementById('timeDisplay').innerText = `â±ï¸ ${survivalTime.toFixed(1)}s`;

                bird.update();
                obstacles.update();
                obstacles.draw();
                bird.draw();

                frames++;
                requestAnimationFrame(loop);
            } 
            else if (gameState === 'GAMEOVER') {
                // éŠæˆ²çµæŸå‹•ç•« (åªè™•ç†é³¥å¢œè½)
                bird.y += bird.velocity;
                bird.velocity += bird.gravity;
                bird.draw();
                obstacles.draw();

                if (bird.y < canvas.height + 200) {
                    requestAnimationFrame(loop);
                }
            }
        }

        document.getElementById('startBtn').addEventListener('click', initAudio);

    </script>
</body>
</html>
